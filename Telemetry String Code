#include <Wire.h>
#include <Adafruit_Sensor.h>
#include <Adafruit_LPS22HB.h>
#include <Adafruit_HTS221.h>
#include <Adafruit_LSM9DS1.h>
#include <Adafruit_MPL3115A2.h>
#include <TinyGPS++.h>
#include <SoftwareSerial.h>
#include <Arduino_BLE.h>

// Create instances of the sensors
Adafruit_LPS22HB lps = Adafruit_LPS22HB();
Adafruit_HTS221 hts = Adafruit_HTS221();
Adafruit_LSM9DS1 lsm = Adafruit_LSM9DS1();
Adafruit_MPL3115A2 mpl = Adafruit_MPL3115A2();
TinyGPSPlus gps;
SoftwareSerial ss(2, 3); // RX, TX
BLEPeripheral blePeripheral; // Create a BLE peripheral

void setup() {
  // Start the I2C and software serial
  Wire.begin();
  ss.begin(9600);

  // Initialize the sensors
  lps.begin();
  hts.begin();
  lsm.begin();
  if (!mpl.begin()) {
    Serial.println("Could not find a valid MPL3115A2 sensor, check wiring!");
    while (1);
  }

  // Create a BLE peripheral
  blePeripheral.setLocalName("Cansat");
  blePeripheral.setDeviceName("Telemetry");
  blePeripheral.begin();
}

void loop() {
  // Read the data from the sensors
  sensors_event_t event;
  lps.getEvent(&event);
  float temperature = hts.readTemperature();
  lsm.readGyro();
  float gx = lsm.gyroData.x;
  float gy = lsm.gyroData.y;
  float gz = lsm.gyroData.z;
  float pressure = mpl.getPressure();
  float altitude = mpl.pressureToAltitude(pressure);
  while (ss.available() > 0) {
    gps.encode(ss.read());
  }

  // Create the telemetry string
  String telemetry = "P:" + String(event.pressure, 2) + "hPa" 
  "T:" + String(temperature, 2) + "C" 
  "Gx:" + String(gx, 2) + "Gy:" + String(gy, 2) + "Gz:" + String(gz, 2) + 
  "A:" + String(altitude, 2) + "m";

  if(gps.location.isValid()){
    telemetry += "Lat:" + String(gps.location.lat(), 6) + "Lon:" + String(gps.location.lng(), 6);
  

  // Print the telemetry
Serial.println(telemetry);
  }

delay(1000);
}
